name: sony-sync-playlist

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch and Randomly Swap Logos
        env:
          SONY_SECRET_URL: ${{ secrets.SONY_URL }}
          PROXY_ADDR: ${{ secrets.SONY_PROXY }}
        run: |
          # 1. Fetch original M3U (Aapka working logic)
          curl -x "$PROXY_ADDR" -L --compressed \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0" \
            -H "Accept: */*" \
            "$SONY_SECRET_URL" -o sony.m3u

          # 2. Safety Check
          if ! grep -q "#EXTM3U" sony.m3u; then
            echo "Invalid M3U received."
            exit 1
          fi

          # 3. Clean and prepare new logos from Slivtv.json
          curl -s "https://raw.githubusercontent.com/ripalbaria/play/refs/heads/main/Slivtv.json" | jq -r '.[].logo' | shuf > logos_list.txt

          # 4. RANDOM REPLACEMENT LOGIC
          # Hum har line ko check karenge, agar Jio logo hai toh list se agla logo uthayenge
          temp_file=$(mktemp)
          exec 3<logos_list.txt

          while IFS= read -r line; do
            if [[ "$line" == *"jiotvimages.cdn.jio.com"* ]]; then
              # List se next random logo read karein
              if read -u 3 next_logo; then
                # tvg-logo="..." ke andar ka content replace karein
                echo "${line/tvg-logo=\"*\"/tvg-logo=\"$next_logo\"}" >> "$temp_file"
              else
                # Agar logos khatam ho gaye toh line ko waise hi rehne dein
                echo "$line" >> "$temp_file"
              fi
            else
              echo "$line" >> "$temp_file"
            fi
          done < sony.m3u

          mv "$temp_file" sony.m3u

          # 5. Name Renaming (Aapka preferred list)
          sed -i 's/Sony SET HD[^,]*/SONY HD/Ig' sony.m3u
          sed -i 's/Sony SAB HD[^,]*/SAB HD/Ig' sony.m3u
          sed -i 's/Sony Pal[^,]*/SONY PAL/Ig' sony.m3u
          sed -i 's/Sony Yay[^,]*/SONY YAY/Ig' sony.m3u
          sed -i 's/Sony Sports Ten 1 HD[^,]*/SONY TEN 1 HD/Ig' sony.m3u
          sed -i 's/Sony Sports Ten 1[^,]*/SONY TEN 1/Ig' sony.m3u
          # ... (Baki sports channels ke liye bhi sed add kar sakte hain)

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GithubBot"
          git config --global user.email "bot@github.com"
          git add sony.m3u
          git diff --quiet && git diff --staged --quiet || (git commit -m "Sony Updated: Random Logos Applied" && git push)
