name: sony-sync-playlist

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Fetch Sony with Proxy
        env:
          SONY_SECRET_URL: ${{ secrets.SONY_URL }}
          PROXY_ADDR: ${{ secrets.SONY_PROXY }}
        run: |
          # --- DO NOT CHANGE THIS FETCH SECTION ---
          curl -x "$PROXY_ADDR" -L --compressed \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0" \
            -H "Accept: */*" \
            -H "Accept-Encoding: gzip" \
            -H "Cache-Control: no-cache, no-store" \
            "$SONY_SECRET_URL" \
            -o sony.m3u

          # --- SAFETY CHECK ---
          if ! grep -q "#EXTM3U" sony.m3u; then
            echo "Invalid M3U received. Skipping processing to protect existing file."
            exit 1
          fi

          # --- LOGO AND NAME REPLACE SECTION ---
          # 1. Clean hidden carriage returns
          sed -i 's/\r//g' sony.m3u

          # 2. Rename Channels (Using | separator to prevent deletions)
          sed -i 's|Sony SET HD|SONY HD|Ig' sony.m3u
          sed -i 's|Sony SAB HD|SAB HD|Ig' sony.m3u
          sed -i 's|Sony Pal|SONY PAL|Ig' sony.m3u
          sed -i 's|Sony Yay|SONY YAY|Ig' sony.m3u
          sed -i 's|Sony Marathi|SONY MARATHI|Ig' sony.m3u
          sed -i 's|Sony Aath|SONY AATH|Ig' sony.m3u
          sed -i 's|Sony MAX HD|SONY MAX HD|Ig' sony.m3u
          sed -i 's|Sony MAX|SONY MAX|Ig' sony.m3u
          sed -i 's|Sony MAX 2|SONY MAX2|Ig' sony.m3u
          sed -i 's|Sony WAH|SONY WAH|Ig' sony.m3u
          sed -i 's|Sony PIX HD|SONY PIX HD|Ig' sony.m3u
          sed -i 's|Sony BBC Earth HD|BBC EARTH|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 1 HD|SONY TEN 1 HD|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 2 HD|SONY TEN 2 HD|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 3 HD|SONY TEN 3 HD|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 4 HD|SONY TEN 4 HD|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 5 HD|SONY TEN 5 HD|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 1|SONY TEN 1|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 2|SONY TEN 2|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 3|SONY TEN 3|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 4|SONY TEN 4|Ig' sony.m3u
          sed -i 's|Sony Sports Ten 5|SONY TEN 5|Ig' sony.m3u

          # 3. Logo Update from JSON
          curl -s "https://raw.githubusercontent.com/ripalbaria/play/refs/heads/main/Slivtv.json" -o logos.json
          
          if [ -s logos.json ]; then
            jq -c '.[]' logos.json | while read -r item; do
              NAME=$(echo "$item" | jq -r '.name')
              LOGO=$(echo "$item" | jq -r '.logo')
              # Safe replacement of the logo URL on the line containing the channel name
              sed -i "/$NAME/I s|tvg-logo=\"[^\"]*\"|tvg-logo=\"$LOGO\"|g" sony.m3u
            done
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GithubBot"
          git config --global user.email "bot@github.com"
          git add sony.m3u
          git diff --quiet && git diff --staged --quiet || (git commit -m "Sony Updated: $(date)" && git push)
